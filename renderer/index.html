<!DOCTYPE html>
<html lang="es-Mx">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Alfred - Asistente Personal</title>
    <link rel="stylesheet" href="./styles/main.css">
</head>

<body>
    <!-- Overlay de carga del backend -->
    <div class="backend-loading-overlay" id="backendLoadingOverlay">
        <div class="backend-loading-content">
            <div class="loading-spinner"></div>
            <h2>Iniciando Alfred</h2>
            <p id="loadingStatusText">Conectando con el backend...</p>
            <div class="loading-progress">
                <div class="loading-progress-bar" id="loadingProgressBar"></div>
            </div>
        </div>
    </div>

    <!-- Barra superior -->
    <div class="topbar">
        <div class="topbar-left">
            <div class="logo">
                <svg width="32" height="32" viewBox="0 0 32 32" fill="none">
                    <circle cx="16" cy="16" r="14" fill="#4a9eff" opacity="0.2" />
                    <path d="M16 8L20 14H12L16 8Z" fill="#4a9eff" />
                    <circle cx="16" cy="18" r="3" fill="#4a9eff" />
                    <path d="M16 21V26" stroke="#4a9eff" stroke-width="2" />
                </svg>
                <h1>Alfred</h1>
            </div>
            <div class="status" id="status">
                <span class="status-dot"></span>
                <span class="status-text">Conectando...</span>
            </div>
        </div>
        <div class="topbar-right">
            <button class="icon-button" onclick="window.createNewConversation()" title="Nueva conversacion">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14" />
                </svg>
            </button>
            <button class="icon-button" id="conversationsBtn" title="Ver conversaciones">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                </svg>
            </button>
            <div class="model-selector">
                <label for="modelSelect">Modelo:</label>
                <select id="modelSelect" class="model-select">
                    <option value="gemma3:4b">Gemma3 4B</option>
                    <option value="gemma3n:e4b">Gemma3n e4B</option>
                    <option value="gemma3:1b">Gemma3 1B</option>
                    <option value="gemma3:12b">Gemma3 12B</option>
                    <option value="gpt-oss:20b">GPT-OSS 20B</option>
                    <option value="gemma2:9b">Gemma2 9B</option>
                </select>
            </div>
            <button class="icon-button" onclick="stopOllama()" title="Detener Ollama (liberar recursos)">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10" />
                    <rect x="9" y="9" width="6" height="6" />
                </svg>
            </button>
            <button class="icon-button" onclick="restartBackend()" title="Reiniciar servidor">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M21 2v6h-6M3 12a9 9 0 0 1 15-6.7L21 8M3 22v-6h6M21 12a9 9 0 0 1-15 6.7L3 16" />
                </svg>
            </button>
            <button class="icon-button" id="historyBtn" title="Ver historial">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path
                        d="M10 3a7 7 0 100 14 7 7 0 000-14zm0 12a5 5 0 110-10 5 5 0 010 10zm1-8H9v4l3.5 2.1.7-1.2-2.2-1.3V7z" />
                </svg>
            </button>
            <button class="icon-button" id="statsBtn" title="EstadÃ­sticas">
                <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M3 17h14v-2H3v2zm0-4h14v-2H3v2zm0-6v2h14V7H3z" />
                </svg>
            </button>
            <button class="icon-button" id="settingsBtn" title="ConfiguraciÃ³n">
                <img src="../assets/cogwheel.png" alt="" width="20" height="20">
            </button>
        </div>
    </div>

    <!-- Contenedor principal -->
    <div class="container">
        <!-- Ãrea de chat -->
        <div class="chat-container">
            <div class="messages" id="messages">
                <div class="welcome-message">
                    <div class="welcome-icon">ðŸ¤–</div>
                    <h2>Â¡Hola! Soy Alfred</h2>
                    <p>Tu asistente personal inteligente</p>
                    <p class="welcome-subtitle">PregÃºntame cualquier cosa sobre tus documentos</p>
                </div>
            </div>

            <!-- Indicador de escritura -->
            <div class="typing-indicator" id="typingIndicator" style="display: none;">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <span>Alfred estÃ¡ escribiendo...</span>
            </div>

            <!-- Input de mensaje -->
            <div class="input-container">
                <textarea id="messageInput" placeholder="Escribe tu mensaje aquÃ­..." rows="1"
                    autocomplete="off"></textarea>
                <div class="input-actions">
                    <button id="searchDocsBtn" class="mode-toggle-btn" title="Buscar en documentos">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z" />
                        </svg>
                        <span>Documentos</span>
                    </button>
                    <button id="promptOnlyBtn" class="mode-toggle-btn active" title="Solo usar el prompt">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path
                                d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm0 14H6l-2 2V4h16v12z" />
                        </svg>
                        <span>Prompt</span>
                    </button>
                    <button id="sendBtn" class="send-button" disabled>
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Panel lateral (oculto por defecto) -->
        <div class="sidebar none" id="sidebar">
            <div class="sidebar-header">
                <h3 id="sidebarTitle">Panel</h3>
                <button class="icon-button" id="closeSidebar">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M15.898 4.045c-.269-.27-.706-.27-.975 0l-4.923 4.923-4.923-4.923c-.27-.27-.706-.27-.975 0s-.27.706 0 .975l4.923 4.923-4.923 4.923c-.27.27-.27.706 0 .975.135.135.312.203.488.203s.353-.068.488-.203l4.923-4.923 4.923 4.923c.135.135.312.203.488.203s.353-.068.488-.203c.27-.269.27-.706 0-.975l-4.923-4.923 4.923-4.923c.27-.269.27-.706 0-.975z" />
                    </svg>
                </button>
            </div>
            <div class="sidebar-content" id="sidebarContent">
                <!-- El contenido se llenarÃ¡ dinÃ¡micamente -->
            </div>
        </div>
    </div>

    <!-- Modal de configuraciÃ³n -->
    <div class="modal none" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ConfiguraciÃ³n</h2>
                <button class="icon-button" id="closeSettings">
                    <svg width="20" height="20" viewBox="0 0 20 20" fill="currentColor">
                        <path
                            d="M15.898 4.045c-.269-.27-.706-.27-.975 0l-4.923 4.923-4.923-4.923c-.27-.27-.706-.27-.975 0s-.27.706 0 .975l4.923 4.923-4.923 4.923c-.27.27-.27.706 0 .975.135.135.312.203.488.203s.353-.068.488-.203l4.923-4.923 4.923 4.923c.135.135.312.203.488.203s.353-.068.488-.203c.27-.269.27-.706 0-.975l-4.923-4.923 4.923-4.923c.27-.269.27-.706 0-.975z" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <!-- SecciÃ³n de foto de perfil -->
                <div class="setting-group profile-section">
                    <label>Foto de perfil</label>
                    <div class="profile-picture-container">
                        <div class="current-profile-picture" id="currentProfilePicture">
                            <span class="default-avatar">ðŸ‘¤</span>
                        </div>
                        <div class="profile-actions">
                            <button class="button secondary" id="changeProfilePictureBtn">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
                                    <path
                                        d="M21 19V5c0-1.1-.9-2-2-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zM8.5 13.5l2.5 3.01L14.5 12l4.5 6H5l3.5-4.5z" />
                                </svg>
                                Cambiar foto
                            </button>
                        </div>
                    </div>

                    <!-- Historial de fotos de perfil -->
                    <div class="profile-history-section">
                        <div class="profile-history-header">
                            <h4>Historial de fotos</h4>
                            <span class="profile-history-count" id="profileHistoryCount">0 fotos</span>
                        </div>
                        <div class="profile-history-gallery" id="profileHistoryGallery">
                            <div class="no-history-message">
                                No hay fotos en el historial
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Configuraciones existentes -->
                <div class="setting-group">
                    <label for="serverUrl">URL del servidor Alfred</label>
                    <input type="text" id="serverUrl" value="http://127.0.0.1:8000" />
                </div>
                
                <!-- Configuracion de Ollama Keep Alive -->
                <div class="setting-group">
                    <label for="ollamaKeepAlive">Tiempo de inactividad de Ollama</label>
                    <div class="keep-alive-controls">
                        <input type="range" id="ollamaKeepAlive" min="0" max="1800" value="30" step="30" />
                        <div class="keep-alive-display">
                            <span id="ollamaKeepAliveValue">30</span> segundos
                        </div>
                    </div>
                    <p class="setting-description">
                        Tiempo que Ollama mantiene el modelo en memoria despues de usarlo. 
                        Valores mas bajos liberan memoria mas rapido, valores mas altos mejoran la velocidad de respuesta.
                    </p>
                    <div class="keep-alive-presets">
                        <button class="preset-btn" data-seconds="0">Inmediato (0s)</button>
                        <button class="preset-btn" data-seconds="30">Rapido (30s)</button>
                        <button class="preset-btn" data-seconds="300">Normal (5min)</button>
                        <button class="preset-btn" data-seconds="1800">Largo (30min)</button>
                    </div>
                </div>
                
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="autoSave" checked />
                        Guardar conversaciones automaticamente
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="useHistory" checked />
                        Buscar en historial primero
                    </label>
                </div>
                <div class="setting-group">
                    <label>
                        <input type="checkbox" id="soundEnabled" />
                        Habilitar sonidos
                    </label>
                </div>
            </div>
            <div class="modal-footer">
                <button class="button secondary" id="cancelSettings">Cancelar</button>
                <button class="button primary" id="saveSettings">Guardar</button>
            </div>
        </div>
    </div>

    <!-- Scripts modulares -->
    <script type="module" src="./renderer.js"></script>
</body>

</html>